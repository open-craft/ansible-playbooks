---
# Playbook to set up common services on any type of appserver.

- name: Set up common services on appservers
  hosts: app
  become: true
  roles:
    - role: consul
      when: consul_servers | length > 0
    - role: node-exporter
      when: NODE_EXPORTER_PASSWORD is not none
    - role: filebeat
      # Appservers may have some Elastic stuff already installed on them.
      filebeat_elastic_apt_pin: 200
      when: filebeat_logstash_hosts | length > 0
  tasks:
    # Bug ref https://github.com/ansible/ansible/issues/11327
    # (Issue is closed, but bug still exists.)
    #
    # Have to force reload nginx to take up the new configuration.
    # consul meta skips nginx-proxy role when consul_http_password is none,
    # which causes node-exporter's nginx-proxy "reload nginx" handler to be
    # skipped as well.
    - name: reload nginx
      service:
        name: nginx
        state: reloaded
