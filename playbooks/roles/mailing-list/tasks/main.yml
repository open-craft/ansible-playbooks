---
- name: install mailman3 packages
  apt:
    name:
      - "mailman3-full"
  notify:
    - "restart mailman3"

- name: Mailman3 mailman.cfg
  template:
    src: "mailman.cfg.j2"
    dest: "/etc/mailman3/mailman.cfg"
  notify:
    - "restart mailman3"

- name: Mailman3 mailman-web.py
  template:
    src: "mailman-web.py.j2"
    dest: "/etc/mailman3/mailman-web.py"
  notify:
    - "restart mailman3"

- name: Mailman3 mailman-hyperkitty.cfg
  template:
    src: "mailman-hyperkitty.cfg.j2"
    dest: "/etc/mailman3/mailman-hyperkitty.cfg"
  notify:
    - "restart mailman3"

# mailman3 core has migrations, but they are run automatically.
# We only need to run the mailman3-web migrations manually here.
- name: Mailman3 web database migrations up to date
  command: "/usr/share/mailman3-web/manage.py migrate"
  become_user: "www-data"
  register: "mailman3_web_migrations"
  changed_when: "'No migrations to apply' not in mailman3_web_migrations.stdout"

- name: Allow 443 tcp port for mailman3 web (nginx reverse proxy)
  ufw:
    rule: "allow"
    port: "443"
    proto: "tcp"

- name: Mailman3 web nginx proxy config
  template:
    src: "mailman3-nginx-proxy.conf.j2"
    dest: "/etc/nginx/sites-available/mailman3"
  notify:
    - "reload nginx"

- name: Mailman3 nginx proxy config sites-enabled
  file:
    src: "/etc/nginx/sites-available/mailman3"
    dest: "/etc/nginx/sites-enabled/mailman3"
    state: "link"
  notify:
    - "reload nginx"

- name: Postfix is installed
  apt:
    pkg: postfix

- name: Postfix is configured for mailman3
  template:
    src: postfix-main.cf
    dest: /etc/postfix/main.cf
  notify: reload postfix
