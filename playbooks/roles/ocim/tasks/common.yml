---

- name: Install system dependencies
  command: make install_system_dependencies
  args:
    chdir: "{{ opencraft_root_dir }}"

- name: Install virtualenv
  pip:
    name: virtualenv
    executable: pip3

- name: Install python requirements
  pip:
    requirements: "{{ opencraft_root_dir }}/requirements.txt"
    virtualenv: "{{ opencraft_virtualenv_dir }}"
    virtualenv_python: python3.5
  become_user: "{{ www_user }}"

- name: Copy archived_cleanup script
  template:
    src: "archived_cleanup.j2"
    dest: "{{ opencraft_root_dir }}/bin/archived_cleanup.sh"
    owner: "{{ www_user }}"
    group: "{{ www_group }}"
    mode: 0750

- name: Add calling management command delete_archived to the crontab
  cron:
    name: "run delete_archived"
    special_time: weekly
    job: "{{ opencraft_root_dir }}/bin/archived_cleanup.sh >> {{ opencraft_root_dir }}/log/delete_archived.log"
    user: "{{ www_user }}"
